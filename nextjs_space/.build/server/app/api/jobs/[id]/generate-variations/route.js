"use strict";(()=>{var e={};e.id=214,e.ids=[214],e.modules={21841:e=>{e.exports=require("@aws-sdk/client-s3")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},67852:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>y,patchFetch:()=>A,requestAsyncStorage:()=>h,routeModule:()=>f,serverHooks:()=>v,staticGenerationAsyncStorage:()=>w});var o={};t.r(o),t.d(o,{POST:()=>p,dynamic:()=>u,maxDuration:()=>c});var a=t(79182),i=t(72007),n=t(56719),s=t(93442),l=t(15649),g=t(11826),d=t(35970),m=t(58697);let u="force-dynamic",c=300;async function p(e,{params:r}){try{let t=await (0,l.getServerSession)(g.L);if(!t?.user)return s.NextResponse.json({error:"Unauthorized"},{status:401});let o=await e.json(),a=Math.min(Math.max(o.count||2,1),4),i=await d._.contentJob.findFirst({where:{id:r.id,userId:t.user.id}});if(!i)return s.NextResponse.json({error:"Job not found"},{status:404});if(!i.transformedImageUrl||!i.videoPrompt)return s.NextResponse.json({error:"Cannot generate variations: Original job incomplete"},{status:400});console.log(`Generating ${a} variations for job ${r.id}`);let n=[],u=Array(a).fill(null).map(async()=>{let e=await (0,m.T8)({imageUrl:i.transformedImageUrl,prompt:i.videoPrompt,duration:5,userId:t.user.id});return d._.jobVariation.create({data:{jobId:i.id,videoUrl:e,thumbnailUrl:i.transformedImageUrl,cost:.035}})}),c=await Promise.all(u);n.push(...c),console.log(`Created ${n.length} variations for job ${r.id}`);let p=n.map(e=>({...e,createdAt:e.createdAt.toISOString()}));return s.NextResponse.json({success:!0,count:n.length,variations:p,totalCost:.035*n.length})}catch(e){return console.error("Variation generation failed:",e),s.NextResponse.json({error:"Variation generation failed",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}let f=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/jobs/[id]/generate-variations/route",pathname:"/api/jobs/[id]/generate-variations",filename:"route",bundlePath:"app/api/jobs/[id]/generate-variations/route"},resolvedPagePath:"/home/ubuntu/instagram_content_generator/nextjs_space/app/api/jobs/[id]/generate-variations/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:h,staticGenerationAsyncStorage:w,serverHooks:v}=f,y="/api/jobs/[id]/generate-variations/route";function A(){return(0,n.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:w})}},11826:(e,r,t)=>{t.d(r,{L:()=>l});var o=t(64617),a=t(66291),i=t(3390),n=t.n(i),s=t(35970);let l={adapter:(0,o.N)(s._),session:{strategy:"jwt"},pages:{signIn:"/auth/login"},providers:[(0,a.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)throw Error("Email et mot de passe requis");let r=await s._.user.findUnique({where:{email:e.email}});if(!r||!await n().compare(e.password,r.password||""))throw Error("Email ou mot de passe incorrect");if(!r.isApproved)throw Error("Votre compte n'a pas encore \xe9t\xe9 approuv\xe9 par l'administrateur. Veuillez patienter.");return{id:r.id,email:r.email,name:r.name||`${r.firstName||""} ${r.lastName||""}`.trim(),firstName:r.firstName,lastName:r.lastName,role:r.role,isApproved:r.isApproved}}})],callbacks:{session:({session:e,token:r})=>({...e,user:{...e.user,id:r.id,firstName:r.firstName,lastName:r.lastName,role:r.role,isApproved:r.isApproved}}),jwt:({token:e,user:r})=>r?{...e,id:r.id,firstName:r.firstName,lastName:r.lastName,role:r.role,isApproved:r.isApproved}:e}}},35970:(e,r,t)=>{t.d(r,{_:()=>a});let o=require("@prisma/client"),a=globalThis.prisma??new o.PrismaClient},58697:(e,r,t)=>{t.d(r,{hb:()=>h,T8:()=>f,Qt:()=>p});var o=t(95342);let a=require("sharp");var i=t.n(a);let n=process.env.FAL_API_KEY||"";async function s(e){try{let r=new Blob([e],{type:"image/jpeg"}),t=await o.fal.storage.upload(r);return console.log("Image uploaded to FAL.ai storage:",t),t}catch(e){if(console.error("Failed to upload to FAL.ai storage:",e),e&&"object"==typeof e&&"status"in e&&401===e.status)throw Error("FAL.ai Authentication failed. Check FAL_API_KEY in .env");throw Error(`Failed to upload to FAL.ai storage: ${e instanceof Error?e.message:"Unknown error"}`)}}async function l(e){console.log("Checking image dimensions for video generation:",e);try{let r=await fetch(e);if(!r.ok)throw Error(`Failed to fetch image: ${r.statusText}`);let t=await r.arrayBuffer(),o=Buffer.from(t),{width:a=0,height:n=0}=await i()(o).metadata();if(console.log(`Original image dimensions: ${a}x${n}`),a<=1920&&n<=1920)return console.log("✅ Image dimensions are within limits, no resizing needed"),e;console.log(`⚠️ Image exceeds 1920x1920, resizing...`);let l=await i()(o).resize(1920,1920,{fit:"inside",withoutEnlargement:!0}).jpeg({quality:90}).toBuffer(),g=await i()(l).metadata();console.log(`Resized dimensions: ${g.width}x${g.height}`);let d=await s(l);return console.log("✅ Resized image uploaded:",d),d}catch(e){throw console.error("Failed to resize image:",e),Error(`Failed to resize image: ${e instanceof Error?e.message:"Unknown error"}`)}}async function g(e,r,t){let a=t||"fal-ai/flux/dev/image-to-image";console.log("Transforming image with FAL.ai:",{model:a,imageUrl:e,prompt:r});try{let t=(await o.fal.subscribe(a,{input:{prompt:r,image_url:e,strength:.8,num_inference_steps:28,guidance_scale:3.5,num_images:1},logs:!0,onQueueUpdate:e=>{"IN_PROGRESS"===e.status&&console.log("Image transformation in progress...")}})).data;if(!t||!t.images||0===t.images.length)throw Error("No images returned from FAL.ai");let i=t.images[0].url;return console.log("✅ Image transformation completed:",i),i}catch(e){if(console.error("❌ FAL.ai image transformation error:",{status:e.status,message:e.message,body:e.body}),401===e.status)throw Error("FAL.ai Authentication failed. Check FAL_API_KEY in .env");if(422===e.status)throw Error(`FAL.ai Invalid parameters: ${JSON.stringify(e.body)}`);throw Error(`FAL.ai API error: ${e instanceof Error?e.message:"Unknown error"}`)}}async function d(e,r,t=5,a){let i=a||"fal-ai/luma-dream-machine/image-to-video";console.log("Generating video with FAL.ai:",{model:i,imageUrl:e,prompt:r,duration:t});try{let t=await l(e),a={prompt:r,image_url:t,aspect_ratio:"9:16",loop:!1};console.log("Video generation input parameters:",JSON.stringify(a,null,2));let n=(await o.fal.subscribe(i,{input:a,logs:!0,onQueueUpdate:e=>{"IN_PROGRESS"===e.status&&console.log("Video generation in progress...")}})).data;if(!n||!n.video||!n.video.url)throw Error("No video returned from FAL.ai");let s=n.video.url;return console.log("✅ Video generation completed:",s),s}catch(e){if(console.error("❌ FAL.ai video generation error:",{status:e.status,message:e.message,body:e.body}),401===e.status)throw Error("FAL.ai Authentication failed. Check FAL_API_KEY in .env");if(422===e.status)throw Error(`FAL.ai Invalid parameters: ${JSON.stringify(e.body)}`);throw Error(`FAL.ai API error: ${e instanceof Error?e.message:"Unknown error"}`)}}async function m(e){console.log("Upscaling image with FAL.ai:",e);try{let r=(await o.fal.subscribe("fal-ai/flux-pro/v1.1/image-to-image",{input:{prompt:"high quality, detailed, sharp, professional photography",image_url:e,strength:.5,num_inference_steps:28,guidance_scale:4,num_images:1},logs:!0,onQueueUpdate:e=>{"IN_PROGRESS"===e.status&&console.log("Image upscaling in progress...")}})).data;if(!r||!r.images||0===r.images.length)throw Error("No images returned from FAL.ai");let t=r.images[0].url;return console.log("✅ Image upscaling completed:",t),t}catch(e){if(console.error("❌ FAL.ai upscaling error:",{status:e.status,message:e.message,body:e.body}),401===e.status)throw Error("FAL.ai Authentication failed. Check FAL_API_KEY in .env");if(422===e.status)throw Error(`FAL.ai Invalid parameters: ${JSON.stringify(e.body)}`);throw Error(`FAL.ai API error: ${e instanceof Error?e.message:"Unknown error"}`)}}n?(console.log("✅ Configuration FAL.ai:",{hasApiKey:!0,apiKeyLength:n.length,apiKeyFormat:n.includes(":")?"KEY:SECRET":"KEY"}),o.fal.config({credentials:n})):(console.error("❌ ERREUR CRITIQUE: FAL_API_KEY manquante dans .env"),console.error("   L'application ne pourra pas g\xe9n\xe9rer de contenu."));var u=t(35970);async function c(e){if(!e)return{imageModel:"fal-ai/flux/dev/image-to-image",videoModel:"fal-ai/luma-dream-machine/image-to-video"};try{let r=await u._.modelPreferences.findUnique({where:{userId:e}});return{imageModel:r?.imageModel||"fal-ai/flux/dev/image-to-image",videoModel:r?.imageToVideoModel||"fal-ai/luma-dream-machine/image-to-video"}}catch(e){return console.error("Failed to fetch user preferences:",e),{imageModel:"fal-ai/flux/dev/image-to-image",videoModel:"fal-ai/luma-dream-machine/image-to-video"}}}async function p(e){let{sourceImageUrl:r,prompt:o,highQuality:a=!1,userId:i}=e;console.log("Starting image transformation:",{sourceImageUrl:r,prompt:o,highQuality:a,userId:i});try{let{imageModel:e}=await c(i);console.log("Using image model:",e);let n=r;if(r.startsWith("http://")||r.startsWith("https://"))console.log("Using existing URL:",r);else{console.log("Generating signed URL from S3 for key:",r);let{downloadFile:e}=await Promise.all([t.e(588),t.e(697)]).then(t.bind(t,50697));n=await e(r),console.log("Signed S3 URL generated:",n)}a&&(console.log("Upscaling image for better quality..."),n=await m(n));let s=await g(n,o,e);return console.log("Image transformation completed:",s),s}catch(e){throw console.error("Image transformation failed:",e),Error(`Failed to transform image: ${e instanceof Error?e.message:"Unknown error"}`)}}async function f(e){let{imageUrl:r,prompt:o,duration:a=5,userId:i}=e;console.log("Starting video generation:",{imageUrl:r,prompt:o,duration:a,userId:i});try{let{videoModel:e}=await c(i);console.log("Using video model:",e);let n=r;if(r.startsWith("http://")||r.startsWith("https://"))console.log("Using existing public URL:",r),n=r;else{console.log("Generating signed URL from S3 for key:",r);let{downloadFile:e}=await Promise.all([t.e(588),t.e(697)]).then(t.bind(t,50697));n=await e(r),console.log("Signed S3 URL generated:",n)}let s=await d(n,o,a,e);return console.log("Video generation completed:",s),s}catch(e){throw console.error("Video generation failed:",e),Error(`Failed to generate video: ${e instanceof Error?e.message:"Unknown error"}`)}}async function h(e){return console.log("Formatting video for Instagram:",e),await new Promise(e=>setTimeout(e,500)),console.log("Video format validated for Instagram Reels"),e}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[372,329,511,609,342],()=>t(67852));module.exports=o})();