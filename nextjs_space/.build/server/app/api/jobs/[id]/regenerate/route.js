"use strict";(()=>{var e={};e.id=3,e.ids=[3],e.modules={21841:e=>{e.exports=require("@aws-sdk/client-s3")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},6048:(e,r,o)=>{o.r(r),o.d(r,{originalPathname:()=>y,patchFetch:()=>A,requestAsyncStorage:()=>h,routeModule:()=>f,serverHooks:()=>v,staticGenerationAsyncStorage:()=>w});var t={};o.r(t),o.d(t,{POST:()=>p,dynamic:()=>u,maxDuration:()=>c});var a=o(79182),i=o(72007),s=o(56719),n=o(93442),l=o(15649),d=o(11826),g=o(35970),m=o(58697);let u="force-dynamic",c=300;async function p(e,{params:r}){try{let e=await (0,l.getServerSession)(d.L);if(!e?.user)return n.NextResponse.json({error:"Unauthorized"},{status:401});let o=await g._.contentJob.findFirst({where:{id:r.id,userId:e.user.id}});if(!o)return n.NextResponse.json({error:"Job not found"},{status:404});if(!o.transformedImageUrl||!o.videoPrompt)return n.NextResponse.json({error:"Cannot regenerate: Original job incomplete"},{status:400});console.log(`Regenerating video for job ${r.id}`);let t=await (0,m.T8)({imageUrl:o.transformedImageUrl,prompt:o.videoPrompt,duration:5,userId:e.user.id}),a=await g._.jobVariation.create({data:{jobId:o.id,videoUrl:t,thumbnailUrl:o.transformedImageUrl,cost:.035}});return console.log(`Created variation ${a.id} for job ${r.id}`),n.NextResponse.json({success:!0,variation:{...a,createdAt:a.createdAt.toISOString()}})}catch(e){return console.error("Regeneration failed:",e),n.NextResponse.json({error:"Regeneration failed",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}let f=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/jobs/[id]/regenerate/route",pathname:"/api/jobs/[id]/regenerate",filename:"route",bundlePath:"app/api/jobs/[id]/regenerate/route"},resolvedPagePath:"/home/ubuntu/instagram_content_generator/nextjs_space/app/api/jobs/[id]/regenerate/route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:h,staticGenerationAsyncStorage:w,serverHooks:v}=f,y="/api/jobs/[id]/regenerate/route";function A(){return(0,s.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:w})}},11826:(e,r,o)=>{o.d(r,{L:()=>l});var t=o(64617),a=o(66291),i=o(3390),s=o.n(i),n=o(35970);let l={adapter:(0,t.N)(n._),session:{strategy:"jwt"},pages:{signIn:"/auth/login"},providers:[(0,a.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)throw Error("Email et mot de passe requis");let r=await n._.user.findUnique({where:{email:e.email}});if(!r||!await s().compare(e.password,r.password||""))throw Error("Email ou mot de passe incorrect");if(!r.isApproved)throw Error("Votre compte n'a pas encore \xe9t\xe9 approuv\xe9 par l'administrateur. Veuillez patienter.");return{id:r.id,email:r.email,name:r.name||`${r.firstName||""} ${r.lastName||""}`.trim(),firstName:r.firstName,lastName:r.lastName,role:r.role,isApproved:r.isApproved}}})],callbacks:{session:({session:e,token:r})=>({...e,user:{...e.user,id:r.id,firstName:r.firstName,lastName:r.lastName,role:r.role,isApproved:r.isApproved}}),jwt:({token:e,user:r})=>r?{...e,id:r.id,firstName:r.firstName,lastName:r.lastName,role:r.role,isApproved:r.isApproved}:e}}},35970:(e,r,o)=>{o.d(r,{_:()=>a});let t=require("@prisma/client"),a=globalThis.prisma??new t.PrismaClient},58697:(e,r,o)=>{o.d(r,{hb:()=>h,T8:()=>f,Qt:()=>p});var t=o(95342);let a=require("sharp");var i=o.n(a);let s=process.env.FAL_API_KEY||"";async function n(e){try{let r=new Blob([e],{type:"image/jpeg"}),o=await t.fal.storage.upload(r);return console.log("Image uploaded to FAL.ai storage:",o),o}catch(e){if(console.error("Failed to upload to FAL.ai storage:",e),e&&"object"==typeof e&&"status"in e&&401===e.status)throw Error("FAL.ai Authentication failed. Check FAL_API_KEY in .env");throw Error(`Failed to upload to FAL.ai storage: ${e instanceof Error?e.message:"Unknown error"}`)}}async function l(e){console.log("Checking image dimensions for video generation:",e);try{let r=await fetch(e);if(!r.ok)throw Error(`Failed to fetch image: ${r.statusText}`);let o=await r.arrayBuffer(),t=Buffer.from(o),{width:a=0,height:s=0}=await i()(t).metadata();if(console.log(`Original image dimensions: ${a}x${s}`),a<=1920&&s<=1920)return console.log("✅ Image dimensions are within limits, no resizing needed"),e;console.log(`⚠️ Image exceeds 1920x1920, resizing...`);let l=await i()(t).resize(1920,1920,{fit:"inside",withoutEnlargement:!0}).jpeg({quality:90}).toBuffer(),d=await i()(l).metadata();console.log(`Resized dimensions: ${d.width}x${d.height}`);let g=await n(l);return console.log("✅ Resized image uploaded:",g),g}catch(e){throw console.error("Failed to resize image:",e),Error(`Failed to resize image: ${e instanceof Error?e.message:"Unknown error"}`)}}async function d(e,r,o){let a=o||"fal-ai/flux/dev/image-to-image";console.log("Transforming image with FAL.ai:",{model:a,imageUrl:e,prompt:r});try{let o=(await t.fal.subscribe(a,{input:{prompt:r,image_url:e,strength:.8,num_inference_steps:28,guidance_scale:3.5,num_images:1},logs:!0,onQueueUpdate:e=>{"IN_PROGRESS"===e.status&&console.log("Image transformation in progress...")}})).data;if(!o||!o.images||0===o.images.length)throw Error("No images returned from FAL.ai");let i=o.images[0].url;return console.log("✅ Image transformation completed:",i),i}catch(e){if(console.error("❌ FAL.ai image transformation error:",{status:e.status,message:e.message,body:e.body}),401===e.status)throw Error("FAL.ai Authentication failed. Check FAL_API_KEY in .env");if(422===e.status)throw Error(`FAL.ai Invalid parameters: ${JSON.stringify(e.body)}`);throw Error(`FAL.ai API error: ${e instanceof Error?e.message:"Unknown error"}`)}}async function g(e,r,o=5,a){let i=a||"fal-ai/luma-dream-machine/image-to-video";console.log("Generating video with FAL.ai:",{model:i,imageUrl:e,prompt:r,duration:o});try{let o=await l(e),a={prompt:r,image_url:o,aspect_ratio:"9:16",loop:!1};console.log("Video generation input parameters:",JSON.stringify(a,null,2));let s=(await t.fal.subscribe(i,{input:a,logs:!0,onQueueUpdate:e=>{"IN_PROGRESS"===e.status&&console.log("Video generation in progress...")}})).data;if(!s||!s.video||!s.video.url)throw Error("No video returned from FAL.ai");let n=s.video.url;return console.log("✅ Video generation completed:",n),n}catch(e){if(console.error("❌ FAL.ai video generation error:",{status:e.status,message:e.message,body:e.body}),401===e.status)throw Error("FAL.ai Authentication failed. Check FAL_API_KEY in .env");if(422===e.status)throw Error(`FAL.ai Invalid parameters: ${JSON.stringify(e.body)}`);throw Error(`FAL.ai API error: ${e instanceof Error?e.message:"Unknown error"}`)}}async function m(e){console.log("Upscaling image with FAL.ai:",e);try{let r=(await t.fal.subscribe("fal-ai/flux-pro/v1.1/image-to-image",{input:{prompt:"high quality, detailed, sharp, professional photography",image_url:e,strength:.5,num_inference_steps:28,guidance_scale:4,num_images:1},logs:!0,onQueueUpdate:e=>{"IN_PROGRESS"===e.status&&console.log("Image upscaling in progress...")}})).data;if(!r||!r.images||0===r.images.length)throw Error("No images returned from FAL.ai");let o=r.images[0].url;return console.log("✅ Image upscaling completed:",o),o}catch(e){if(console.error("❌ FAL.ai upscaling error:",{status:e.status,message:e.message,body:e.body}),401===e.status)throw Error("FAL.ai Authentication failed. Check FAL_API_KEY in .env");if(422===e.status)throw Error(`FAL.ai Invalid parameters: ${JSON.stringify(e.body)}`);throw Error(`FAL.ai API error: ${e instanceof Error?e.message:"Unknown error"}`)}}s?(console.log("✅ Configuration FAL.ai:",{hasApiKey:!0,apiKeyLength:s.length,apiKeyFormat:s.includes(":")?"KEY:SECRET":"KEY"}),t.fal.config({credentials:s})):(console.error("❌ ERREUR CRITIQUE: FAL_API_KEY manquante dans .env"),console.error("   L'application ne pourra pas g\xe9n\xe9rer de contenu."));var u=o(35970);async function c(e){if(!e)return{imageModel:"fal-ai/flux/dev/image-to-image",videoModel:"fal-ai/luma-dream-machine/image-to-video"};try{let r=await u._.modelPreferences.findUnique({where:{userId:e}});return{imageModel:r?.imageModel||"fal-ai/flux/dev/image-to-image",videoModel:r?.imageToVideoModel||"fal-ai/luma-dream-machine/image-to-video"}}catch(e){return console.error("Failed to fetch user preferences:",e),{imageModel:"fal-ai/flux/dev/image-to-image",videoModel:"fal-ai/luma-dream-machine/image-to-video"}}}async function p(e){let{sourceImageUrl:r,prompt:t,highQuality:a=!1,userId:i}=e;console.log("Starting image transformation:",{sourceImageUrl:r,prompt:t,highQuality:a,userId:i});try{let{imageModel:e}=await c(i);console.log("Using image model:",e);let s=r;if(r.startsWith("http://")||r.startsWith("https://"))console.log("Using existing URL:",r);else{console.log("Generating signed URL from S3 for key:",r);let{downloadFile:e}=await Promise.all([o.e(588),o.e(697)]).then(o.bind(o,50697));s=await e(r),console.log("Signed S3 URL generated:",s)}a&&(console.log("Upscaling image for better quality..."),s=await m(s));let n=await d(s,t,e);return console.log("Image transformation completed:",n),n}catch(e){throw console.error("Image transformation failed:",e),Error(`Failed to transform image: ${e instanceof Error?e.message:"Unknown error"}`)}}async function f(e){let{imageUrl:r,prompt:t,duration:a=5,userId:i}=e;console.log("Starting video generation:",{imageUrl:r,prompt:t,duration:a,userId:i});try{let{videoModel:e}=await c(i);console.log("Using video model:",e);let s=r;if(r.startsWith("http://")||r.startsWith("https://"))console.log("Using existing public URL:",r),s=r;else{console.log("Generating signed URL from S3 for key:",r);let{downloadFile:e}=await Promise.all([o.e(588),o.e(697)]).then(o.bind(o,50697));s=await e(r),console.log("Signed S3 URL generated:",s)}let n=await g(s,t,a,e);return console.log("Video generation completed:",n),n}catch(e){throw console.error("Video generation failed:",e),Error(`Failed to generate video: ${e instanceof Error?e.message:"Unknown error"}`)}}async function h(e){return console.log("Formatting video for Instagram:",e),await new Promise(e=>setTimeout(e,500)),console.log("Video format validated for Instagram Reels"),e}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),t=r.X(0,[372,329,511,609,342],()=>o(6048));module.exports=t})();