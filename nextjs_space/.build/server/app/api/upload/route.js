"use strict";(()=>{var e={};e.id=998,e.ids=[998,697],e.modules={21841:e=>{e.exports=require("@aws-sdk/client-s3")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},18465:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>F,patchFetch:()=>x,requestAsyncStorage:()=>E,routeModule:()=>A,serverHooks:()=>v,staticGenerationAsyncStorage:()=>y});var a={};t.r(a),t.d(a,{POST:()=>p,dynamic:()=>c});var o=t(79182),i=t(72007),n=t(56719),s=t(93442),l=t(15649),d=t(11826),m=t(35970),g=t(50697),u=t(58697);let c="force-dynamic";async function p(e){try{let r=await (0,l.getServerSession)(d.L);if(!r?.user)return s.NextResponse.json({error:"Unauthorized"},{status:401});let t=await e.formData(),a=t.get("file"),o=t.get("imagePrompt"),i=t.get("videoPrompt");if(!a)return s.NextResponse.json({error:"No file provided"},{status:400});if(!o||!i)return s.NextResponse.json({error:"Image and video prompts are required"},{status:400});if(!a.type.startsWith("image/"))return s.NextResponse.json({error:"File must be an image"},{status:400});if(a.size>10485760)return s.NextResponse.json({error:"File too large"},{status:400});let n=Buffer.from(await a.arrayBuffer()),u=await (0,g.cT)(n,a.name),c=await m._.contentJob.create({data:{userId:r.user.id,originalImageUrl:u,imagePrompt:o,videoPrompt:i,status:"PENDING",progress:0,currentStage:"TRANSFORM"}});return f(c.id,u,o,i,r.user.id),s.NextResponse.json({jobId:c.id,message:"File uploaded successfully"})}catch(e){return console.error("Upload error:",e),s.NextResponse.json({error:"Failed to upload file"},{status:500})}}async function f(e,r,t,a,o){try{await w(e,"PROCESSING",10,"TRANSFORM"),console.log(`[Job ${e}] Starting image transformation...`);let i=await (0,u.Qt)({sourceImageUrl:r,prompt:t,userId:o});await w(e,"PROCESSING",40,"TRANSFORM",{transformedImageUrl:i}),await w(e,"PROCESSING",50,"ANIMATE"),console.log(`[Job ${e}] Starting video animation...`);let n=await (0,u.T8)({imageUrl:i,prompt:a,duration:15,userId:o});await w(e,"PROCESSING",80,"ANIMATE",{animatedVideoUrl:n}),await w(e,"PROCESSING",90,"FORMAT"),console.log(`[Job ${e}] Formatting for Instagram...`);let s=await (0,u.hb)(n);await w(e,"PROCESSING",95,"FORMAT");let l=.025+.05;await h(e,"COMPLETED",100,"COMPLETED",{finalVideoUrl:s},l),console.log(`[Job ${e}] Processing completed successfully! Total cost: $${l}`)}catch(r){console.error(`[Job ${e}] Processing error:`,r),await w(e,"FAILED",0,"TRANSFORM",{},r instanceof Error?r.message:"Processing failed")}}async function w(e,r,t,a,o={},i){let n={status:r,progress:t,currentStage:a,updatedAt:new Date};o.transformedImageUrl&&(n.transformedImageUrl=o.transformedImageUrl),o.animatedVideoUrl&&(n.animatedVideoUrl=o.animatedVideoUrl),o.finalVideoUrl&&(n.finalVideoUrl=o.finalVideoUrl),i&&(n.errorMessage=i),"COMPLETED"===r&&(n.completedAt=new Date),await m._.contentJob.update({where:{id:e},data:n})}async function h(e,r,t,a,o={},i){let n={status:r,progress:t,currentStage:a,updatedAt:new Date,cost:i};o.transformedImageUrl&&(n.transformedImageUrl=o.transformedImageUrl),o.animatedVideoUrl&&(n.animatedVideoUrl=o.animatedVideoUrl),o.finalVideoUrl&&(n.finalVideoUrl=o.finalVideoUrl),"COMPLETED"===r&&(n.completedAt=new Date),await m._.contentJob.update({where:{id:e},data:n})}let A=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/upload/route",pathname:"/api/upload",filename:"route",bundlePath:"app/api/upload/route"},resolvedPagePath:"/home/ubuntu/instagram_content_generator/nextjs_space/app/api/upload/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:E,staticGenerationAsyncStorage:y,serverHooks:v}=A,F="/api/upload/route";function x(){return(0,n.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:y})}},11826:(e,r,t)=>{t.d(r,{L:()=>l});var a=t(64617),o=t(66291),i=t(3390),n=t.n(i),s=t(35970);let l={adapter:(0,a.N)(s._),session:{strategy:"jwt"},pages:{signIn:"/auth/login"},providers:[(0,o.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)throw Error("Email et mot de passe requis");let r=await s._.user.findUnique({where:{email:e.email}});if(!r||!await n().compare(e.password,r.password||""))throw Error("Email ou mot de passe incorrect");if(!r.isApproved)throw Error("Votre compte n'a pas encore \xe9t\xe9 approuv\xe9 par l'administrateur. Veuillez patienter.");return{id:r.id,email:r.email,name:r.name||`${r.firstName||""} ${r.lastName||""}`.trim(),firstName:r.firstName,lastName:r.lastName,role:r.role,isApproved:r.isApproved}}})],callbacks:{session:({session:e,token:r})=>({...e,user:{...e.user,id:r.id,firstName:r.firstName,lastName:r.lastName,role:r.role,isApproved:r.isApproved}}),jwt:({token:e,user:r})=>r?{...e,id:r.id,firstName:r.firstName,lastName:r.lastName,role:r.role,isApproved:r.isApproved}:e}}},35970:(e,r,t)=>{t.d(r,{_:()=>o});let a=require("@prisma/client"),o=globalThis.prisma??new a.PrismaClient},58697:(e,r,t)=>{t.d(r,{hb:()=>w,T8:()=>f,Qt:()=>p});var a=t(95342);let o=require("sharp");var i=t.n(o);let n=process.env.FAL_API_KEY||"";async function s(e){try{let r=new Blob([e],{type:"image/jpeg"}),t=await a.fal.storage.upload(r);return console.log("Image uploaded to FAL.ai storage:",t),t}catch(e){if(console.error("Failed to upload to FAL.ai storage:",e),e&&"object"==typeof e&&"status"in e&&401===e.status)throw Error("FAL.ai Authentication failed. Check FAL_API_KEY in .env");throw Error(`Failed to upload to FAL.ai storage: ${e instanceof Error?e.message:"Unknown error"}`)}}async function l(e){console.log("Checking image dimensions for video generation:",e);try{let r=await fetch(e);if(!r.ok)throw Error(`Failed to fetch image: ${r.statusText}`);let t=await r.arrayBuffer(),a=Buffer.from(t),{width:o=0,height:n=0}=await i()(a).metadata();if(console.log(`Original image dimensions: ${o}x${n}`),o<=1920&&n<=1920)return console.log("✅ Image dimensions are within limits, no resizing needed"),e;console.log(`⚠️ Image exceeds 1920x1920, resizing...`);let l=await i()(a).resize(1920,1920,{fit:"inside",withoutEnlargement:!0}).jpeg({quality:90}).toBuffer(),d=await i()(l).metadata();console.log(`Resized dimensions: ${d.width}x${d.height}`);let m=await s(l);return console.log("✅ Resized image uploaded:",m),m}catch(e){throw console.error("Failed to resize image:",e),Error(`Failed to resize image: ${e instanceof Error?e.message:"Unknown error"}`)}}async function d(e,r,t){let o=t||"fal-ai/flux/dev/image-to-image";console.log("Transforming image with FAL.ai:",{model:o,imageUrl:e,prompt:r});try{let t=(await a.fal.subscribe(o,{input:{prompt:r,image_url:e,strength:.8,num_inference_steps:28,guidance_scale:3.5,num_images:1},logs:!0,onQueueUpdate:e=>{"IN_PROGRESS"===e.status&&console.log("Image transformation in progress...")}})).data;if(!t||!t.images||0===t.images.length)throw Error("No images returned from FAL.ai");let i=t.images[0].url;return console.log("✅ Image transformation completed:",i),i}catch(e){if(console.error("❌ FAL.ai image transformation error:",{status:e.status,message:e.message,body:e.body}),401===e.status)throw Error("FAL.ai Authentication failed. Check FAL_API_KEY in .env");if(422===e.status)throw Error(`FAL.ai Invalid parameters: ${JSON.stringify(e.body)}`);throw Error(`FAL.ai API error: ${e instanceof Error?e.message:"Unknown error"}`)}}async function m(e,r,t=5,o){let i=o||"fal-ai/luma-dream-machine/image-to-video";console.log("Generating video with FAL.ai:",{model:i,imageUrl:e,prompt:r,duration:t});try{let t=await l(e),o={prompt:r,image_url:t,aspect_ratio:"9:16",loop:!1};console.log("Video generation input parameters:",JSON.stringify(o,null,2));let n=(await a.fal.subscribe(i,{input:o,logs:!0,onQueueUpdate:e=>{"IN_PROGRESS"===e.status&&console.log("Video generation in progress...")}})).data;if(!n||!n.video||!n.video.url)throw Error("No video returned from FAL.ai");let s=n.video.url;return console.log("✅ Video generation completed:",s),s}catch(e){if(console.error("❌ FAL.ai video generation error:",{status:e.status,message:e.message,body:e.body}),401===e.status)throw Error("FAL.ai Authentication failed. Check FAL_API_KEY in .env");if(422===e.status)throw Error(`FAL.ai Invalid parameters: ${JSON.stringify(e.body)}`);throw Error(`FAL.ai API error: ${e instanceof Error?e.message:"Unknown error"}`)}}async function g(e){console.log("Upscaling image with FAL.ai:",e);try{let r=(await a.fal.subscribe("fal-ai/flux-pro/v1.1/image-to-image",{input:{prompt:"high quality, detailed, sharp, professional photography",image_url:e,strength:.5,num_inference_steps:28,guidance_scale:4,num_images:1},logs:!0,onQueueUpdate:e=>{"IN_PROGRESS"===e.status&&console.log("Image upscaling in progress...")}})).data;if(!r||!r.images||0===r.images.length)throw Error("No images returned from FAL.ai");let t=r.images[0].url;return console.log("✅ Image upscaling completed:",t),t}catch(e){if(console.error("❌ FAL.ai upscaling error:",{status:e.status,message:e.message,body:e.body}),401===e.status)throw Error("FAL.ai Authentication failed. Check FAL_API_KEY in .env");if(422===e.status)throw Error(`FAL.ai Invalid parameters: ${JSON.stringify(e.body)}`);throw Error(`FAL.ai API error: ${e instanceof Error?e.message:"Unknown error"}`)}}n?(console.log("✅ Configuration FAL.ai:",{hasApiKey:!0,apiKeyLength:n.length,apiKeyFormat:n.includes(":")?"KEY:SECRET":"KEY"}),a.fal.config({credentials:n})):(console.error("❌ ERREUR CRITIQUE: FAL_API_KEY manquante dans .env"),console.error("   L'application ne pourra pas g\xe9n\xe9rer de contenu."));var u=t(35970);async function c(e){if(!e)return{imageModel:"fal-ai/flux/dev/image-to-image",videoModel:"fal-ai/luma-dream-machine/image-to-video"};try{let r=await u._.modelPreferences.findUnique({where:{userId:e}});return{imageModel:r?.imageModel||"fal-ai/flux/dev/image-to-image",videoModel:r?.imageToVideoModel||"fal-ai/luma-dream-machine/image-to-video"}}catch(e){return console.error("Failed to fetch user preferences:",e),{imageModel:"fal-ai/flux/dev/image-to-image",videoModel:"fal-ai/luma-dream-machine/image-to-video"}}}async function p(e){let{sourceImageUrl:r,prompt:a,highQuality:o=!1,userId:i}=e;console.log("Starting image transformation:",{sourceImageUrl:r,prompt:a,highQuality:o,userId:i});try{let{imageModel:e}=await c(i);console.log("Using image model:",e);let n=r;if(r.startsWith("http://")||r.startsWith("https://"))console.log("Using existing URL:",r);else{console.log("Generating signed URL from S3 for key:",r);let{downloadFile:e}=await Promise.all([t.e(588),t.e(697)]).then(t.bind(t,50697));n=await e(r),console.log("Signed S3 URL generated:",n)}o&&(console.log("Upscaling image for better quality..."),n=await g(n));let s=await d(n,a,e);return console.log("Image transformation completed:",s),s}catch(e){throw console.error("Image transformation failed:",e),Error(`Failed to transform image: ${e instanceof Error?e.message:"Unknown error"}`)}}async function f(e){let{imageUrl:r,prompt:a,duration:o=5,userId:i}=e;console.log("Starting video generation:",{imageUrl:r,prompt:a,duration:o,userId:i});try{let{videoModel:e}=await c(i);console.log("Using video model:",e);let n=r;if(r.startsWith("http://")||r.startsWith("https://"))console.log("Using existing public URL:",r),n=r;else{console.log("Generating signed URL from S3 for key:",r);let{downloadFile:e}=await Promise.all([t.e(588),t.e(697)]).then(t.bind(t,50697));n=await e(r),console.log("Signed S3 URL generated:",n)}let s=await m(n,a,o,e);return console.log("Video generation completed:",s),s}catch(e){throw console.error("Video generation failed:",e),Error(`Failed to generate video: ${e instanceof Error?e.message:"Unknown error"}`)}}async function w(e){return console.log("Formatting video for Instagram:",e),await new Promise(e=>setTimeout(e,500)),console.log("Video format validated for Instagram Reels"),e}},50697:(e,r,t)=>{t.d(r,{downloadFile:()=>d,cT:()=>l});var a=t(21841),o=t(25588);let i=new a.S3Client({}),{bucketName:n,folderPrefix:s}={bucketName:process.env.AWS_BUCKET_NAME,folderPrefix:process.env.AWS_FOLDER_PREFIX||""};async function l(e,r){let t=`${s}uploads/${Date.now()}-${r}`,o=new a.PutObjectCommand({Bucket:n,Key:t,Body:e,ContentType:function(e){switch(e.split(".").pop()?.toLowerCase()){case"jpg":case"jpeg":return"image/jpeg";case"png":return"image/png";case"webp":return"image/webp";case"mp4":return"video/mp4";case"mov":return"video/quicktime";default:return"application/octet-stream"}}(r)});return await i.send(o),t}async function d(e){let r=new a.GetObjectCommand({Bucket:n,Key:e});return(0,o.e)(i,r,{expiresIn:3600})}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[372,329,511,609,342,588],()=>t(18465));module.exports=a})();